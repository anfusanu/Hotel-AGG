<div class="page-heading">
  <div class="page-title">
    <div class="row">
      <div class="col-12 col-md-6 order-md-1 order-last">
        <h3>File Uploader</h3>
        <p class="text-subtitle text-muted">File uploader that makes user easier to upload their files</p>
      </div>

    </div>
  </div>
  <section class="section">
    <div class="row">

      <div class="col-12 col-md-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title">ImgBB Uploader</h5>
          </div>
          <div class="card-content">
            <div class="card-body">

              <!-- imgBB file uploader -->
              <input type="file" name="image" class="imgbb-filepond">
            </div>
          </div>
        </div>
      </div>

      <form action="/registration/image-upload" method="POST" enctype="multipart/form-data">
        <div class="col-12 col-md-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title">Multiple Files</h5>
            </div>
            <div class="card-content">
              <div class="card-body">

                <!-- File uploader with multiple files upload -->
                <input type="file" class="multiple-files-filepond" multiple>
              </div>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" type="submit"> Submit</button>
      </form>


    </div>
  </section>
</div>



<!-- filepond validation -->
<script src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.js"></script>
<script src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script>

<!-- image editor -->
<script src="https://unpkg.com/filepond-plugin-image-exif-orientation/dist/filepond-plugin-image-exif-orientation.js">
</script>
<script src="https://unpkg.com/filepond-plugin-image-crop/dist/filepond-plugin-image-crop.js"></script>
<script src="https://unpkg.com/filepond-plugin-image-filter/dist/filepond-plugin-image-filter.js"></script>
<script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
<script src="https://unpkg.com/filepond-plugin-image-resize/dist/filepond-plugin-image-resize.js"></script>

<!-- toastify -->
<script src="/templates/admin-template/vendors/toastify/toastify.js"></script>

<!-- filepond -->
<script src="https://unpkg.com/filepond/dist/filepond.js"></script>
<script>
  // register desired plugins...
  FilePond.registerPlugin(
    // validates the size of the file...
    FilePondPluginFileValidateSize,
    // validates the file type...
    FilePondPluginFileValidateType,

    // calculates & dds cropping info based on the input image dimensions and the set crop ratio...
    FilePondPluginImageCrop,
    // preview the image file type...
    FilePondPluginImagePreview,
    // filter the image file
    FilePondPluginImageFilter,
    // corrects mobile image orientation...
    FilePondPluginImageExifOrientation,
    // calculates & adds resize information...
    FilePondPluginImageResize,
  );



  // Filepond: ImgBB with server property
  FilePond.create(document.querySelector('.imgbb-filepond'), {
    allowImagePreview: true,
    allowMultiple: true,
    allowFileEncode: false,
    server: {
      process: (fieldName, file, metadata, load, error, progress, abort) => {
        console.log(file)
        console.log('{{userId}}')
        // We ignore the metadata property and only send the file

        const formData = new FormData();
        formData.append(fieldName, file, '{{userId}}');

        const request = new XMLHttpRequest();
        // you can change it by your client api key
        request.open('POST', 'https://api.imgbb.com/1/upload?key=2dc5a60aca89b60f026c3df943f63177');
        request.upload.onprogress = (e) => {
          progress(e.lengthComputable, e.loaded, e.total);
        };

        request.onload = function () {
          if (request.status >= 200 && request.status < 300) {
            load(request.responseText);
          } else {
            error('oh no');
          }
        };

        request.onreadystatechange = function () {
          if (this.readyState == 4) {
            if (this.status == 200) {
              let response = JSON.parse(this.responseText);

              Toastify({
                text: "Success uploading to imgbb! see console f12",
                duration: 3000,
                close: true,
                gravity: "bottom",
                position: "right",
                backgroundColor: "#4fbe87",
              }).showToast();

              console.log(response);
            } else {
              Toastify({
                text: "Failed uploading to imgbb! see console f12",
                duration: 3000,
                close: true,
                gravity: "bottom",
                position: "right",
                backgroundColor: "#ff0000",
              }).showToast();

              console.log("Error", this.statusText);
            }
          }
        };

        request.send(formData);
      }
    }
  });


  // Filepond: Multiple Files
  FilePond.create(document.querySelector('.multiple-files-filepond'), {
    allowImagePreview: false,
    allowMultiple: true,
    allowFileEncode: false,
    required: false
  });
</script>